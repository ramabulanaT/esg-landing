<!DOCTYPE html>
<html lang="en">
<head>
  <script src="/js/auth-guard.js"></script>
  <script src="/js/api-client.js"></script>
<meta charset="UTF-8"><title>AI Assistant | ESG Navigator</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:#0a0a0f;color:#fff;height:100vh;display:flex;flex-direction:column}
header{background:rgba(10,10,15,.95);border-bottom:1px solid rgba(255,255,255,.06);padding:0 2rem;height:56px;display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:.6rem;text-decoration:none;color:#fff;font-size:.82rem;font-weight:600;letter-spacing:.06em}
.logo-mark{width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,#d4af37,#b8960b);display:grid;place-items:center;font-size:.5rem;font-weight:800;color:#000}
nav a{font-size:.78rem;color:rgba(255,255,255,.45);text-decoration:none;margin-left:1.5rem}
nav a:hover{color:#d4af37}
nav a.active{color:#d4af37}
.container{max-width:1100px;width:100%;margin:0 auto;padding:1.5rem 2rem;flex:1;display:flex;gap:1.5rem;overflow:hidden}
/* Sidebar */
.sidebar{width:280px;flex-shrink:0;display:flex;flex-direction:column;gap:1rem}
.search-box{position:relative}
.search-box input{width:100%;padding:.65rem 1rem .65rem 2.2rem;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:8px;color:#fff;font-size:.82rem;outline:none}
.search-box input:focus{border-color:#d4af37}
.search-box::before{content:'üîç';position:absolute;left:.7rem;top:50%;transform:translateY(-50%);font-size:.7rem}
.company-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:2px}
.company-item{padding:.6rem .8rem;border-radius:6px;cursor:pointer;font-size:.78rem;display:flex;justify-content:space-between;align-items:center;transition:background .15s}
.company-item:hover{background:rgba(212,175,55,.08)}
.company-item.selected{background:rgba(212,175,55,.15);border-left:2px solid #d4af37}
.company-item .score{font-size:.7rem;font-weight:600;padding:2px 6px;border-radius:4px}
.score-high{background:rgba(34,197,94,.15);color:#22c55e}
.score-mid{background:rgba(234,179,8,.15);color:#eab308}
.score-low{background:rgba(239,68,68,.15);color:#ef4444}
.sector-filter{display:flex;flex-wrap:wrap;gap:4px}
.sector-btn{font-size:.65rem;padding:3px 8px;border-radius:4px;border:1px solid rgba(255,255,255,.08);background:none;color:rgba(255,255,255,.5);cursor:pointer}
.sector-btn:hover,.sector-btn.active{border-color:#d4af37;color:#d4af37}
.stats-bar{font-size:.7rem;color:rgba(255,255,255,.35);padding:.5rem 0;border-top:1px solid rgba(255,255,255,.06)}
/* Chat area */
.chat-area{flex:1;display:flex;flex-direction:column;min-width:0}
.chat-header{padding:.75rem 0;border-bottom:1px solid rgba(255,255,255,.06);margin-bottom:1rem}
.chat-header h2{font-size:1rem;font-weight:600}
.chat-header p{font-size:.75rem;color:rgba(255,255,255,.35);margin-top:.2rem}
#msgs{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:1rem;padding-bottom:1rem}
.msg{max-width:85%;padding:.85rem 1.1rem;border-radius:10px;font-size:.84rem;line-height:1.6}
.msg.bot{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);align-self:flex-start}
.msg.user{background:rgba(212,175,55,.12);border:1px solid rgba(212,175,55,.2);align-self:flex-end}
.msg pre{background:rgba(0,0,0,.3);padding:.5rem;border-radius:4px;overflow-x:auto;font-size:.75rem;margin:.5rem 0}
.msg strong{color:#d4af37}
.input-area{border-top:1px solid rgba(255,255,255,.06);padding:1rem 0 0;display:flex;gap:.75rem}
.input-area textarea{flex:1;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:.75rem 1rem;color:#fff;font-family:system-ui;font-size:.84rem;resize:none;outline:none;line-height:1.5}
.input-area textarea:focus{border-color:#d4af37}
.send-btn{width:44px;height:44px;border-radius:10px;border:none;background:#d4af37;color:#000;cursor:pointer;font-size:1.1rem;font-weight:700}
.send-btn:hover{background:#c4a030}
.send-btn:disabled{opacity:.4;cursor:not-allowed}
/* Analysis card */
.analysis-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:1rem;margin:.5rem 0}
.analysis-card h3{font-size:.9rem;color:#d4af37;margin-bottom:.75rem}
.esg-bars{display:flex;gap:1rem;margin:.5rem 0}
.esg-bar{flex:1}
.esg-bar label{font-size:.65rem;color:rgba(255,255,255,.5);display:block;margin-bottom:4px}
.esg-bar .bar{height:6px;border-radius:3px;background:rgba(255,255,255,.08)}
.esg-bar .bar-fill{height:100%;border-radius:3px;transition:width .5s}
.bar-e .bar-fill{background:#22c55e}
.bar-s .bar-fill{background:#3b82f6}
.bar-g .bar-fill{background:#a855f7}
.metric-row{display:flex;justify-content:space-between;font-size:.78rem;padding:.3rem 0;border-bottom:1px solid rgba(255,255,255,.04)}
.metric-row:last-child{border:none}
.loading{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.1);border-top-color:#d4af37;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){.container{flex-direction:column}.sidebar{width:100%;max-height:200px}}
</style>
</head>
<body>
<header>
<a href="/" class="logo"><span class="logo-mark">ESG</span>ESG NAVIGATOR</a>
<nav><a href="/dashboard.html">Dashboard</a><a href="/assistant.html" class="active">Assistant</a><a href="/pricing.html">Pricing</a><a href="/training.html">Training</a></nav>
</header>
<div class="container">
<div class="sidebar">
<div class="search-box"><input type="text" id="search" placeholder="Search 307 companies..."></div>
<div class="sector-filter" id="sectors"></div>
<div class="stats-bar" id="stats">Loading companies...</div>
<div class="company-list" id="companyList"></div>
</div>
<div class="chat-area">
<div class="chat-header"><h2>ESG Intelligence Assistant</h2><p>Powered by 9 AI agents ‚Äî Select a company or ask a question</p></div>
<div id="msgs"></div>
<div class="input-area">
<textarea id="inp" rows="1" placeholder="Ask about any company's ESG performance, compliance, or risk..."></textarea>
<button class="send-btn" id="sbtn">‚Üí</button>
</div>
</div>
</div>
<script>
const API='https://intellimat-repository-production-199f.up.railway.app';
let companies=[],filtered=[],selected=null,activeSector=null;

async function loadCompanies(){
  try{
    const r=await fetch(API+'/api/suppliers?limit=307');
    const d=await r.json();
    companies=d.companies||[];
    filtered=[...companies];
    renderSectors();
    renderList();
    document.getElementById('stats').textContent=companies.length+' companies loaded | '+new Set(companies.map(c=>c.sector).filter(Boolean)).size+' sectors';
    addMsg('bot','Welcome to ESG Navigator Intelligence. I have **'+companies.length+' JSE-listed companies** loaded with full ESG analysis.\n\nYou can:\n- **Select a company** from the left panel for detailed analysis\n- **Ask questions** like "show me high risk mining companies" or "compare Standard Bank vs Discovery"\n- **Request reports** like "executive portfolio summary" or "sector breakdown"');
  }catch(e){
    document.getElementById('stats').textContent='‚ö†Ô∏è API offline ‚Äî check Railway';
    addMsg('bot','‚ö†Ô∏è Unable to connect to the ESG Navigator API. Please check that Railway is running.');
  }
}

function renderSectors(){
  const secs=[...new Set(companies.map(c=>c.sector).filter(Boolean))].sort();
  const el=document.getElementById('sectors');
  el.innerHTML='<button class="sector-btn active" onclick="filterSector(null)">All</button>'+secs.map(s=>'<button class="sector-btn" onclick="filterSector(\''+s+'\')">'+s+'</button>').join('');
}

function filterSector(s){
  activeSector=s;
  filtered=s?companies.filter(c=>c.sector===s):[...companies];
  renderList();
  document.querySelectorAll('.sector-btn').forEach(b=>b.classList.toggle('active',s?b.textContent===s:b.textContent==='All'));
}

function renderList(){
  const q=document.getElementById('search').value.toLowerCase();
  const show=filtered.filter(c=>!q||c.name.toLowerCase().includes(q)).slice(0,50);
  document.getElementById('companyList').innerHTML=show.map(c=>{
    const sc=c.esg_score||0;
    const cls=sc>=75?'score-high':sc>=50?'score-mid':'score-low';
    const sel=selected&&selected.id===c.id?'selected':'';
    return'<div class="company-item '+sel+'" onclick="selectCompany('+c.id+')"><span>'+c.name+'</span><span class="score '+cls+'">'+sc+'</span></div>';
  }).join('');
}

async function selectCompany(id){
  const c=companies.find(x=>x.id===id);
  if(!c)return;
  selected=c;
  renderList();
  addMsg('user','Analyze **'+c.name+'**');
  const loadId=addMsg('bot','<div class="loading"></div> Analyzing '+c.name+'...');
  try{
    const r=await fetch(API+'/api/suppliers/analyze/'+encodeURIComponent(c.name));
    const d=await r.json();
    if(d.success){
      removeMsg(loadId);
      addAnalysisCard(d.company,d.analysis);
    }else{
      updateMsg(loadId,'‚ùå Analysis failed: '+(d.error||'Unknown error'));
    }
  }catch(e){
    updateMsg(loadId,'‚ùå Connection error: '+e.message);
  }
}

function addAnalysisCard(c,a){
  const e=c.environmental_score||0,s=c.social_score||0,g=c.governance_score||0;
  const risk=c.risk_level||'unknown';
  const riskColor=risk==='low'?'#22c55e':risk==='medium'?'#eab308':risk==='high'?'#f97316':'#ef4444';
  const pos=a.sectorComparison?a.sectorComparison.position:'N/A';
  const peers=a.sectorComparison?a.sectorComparison.peerCount:0;
  const avgPeer=a.sectorComparison?a.sectorComparison.avgSectorEsgScore:0;
  
  const html='<div class="analysis-card"><h3>'+c.name+' ‚Äî ESG Analysis</h3>'+
    '<div class="metric-row"><span>Overall ESG Score</span><strong>'+(c.esg_score||'N/A')+'/100</strong></div>'+
    '<div class="metric-row"><span>Sector</span><span>'+c.sector+' / '+c.industry+'</span></div>'+
    '<div class="metric-row"><span>Risk Level</span><span style="color:'+riskColor+'">‚óè</span> <span>'+risk.toUpperCase()+'</span></div>'+
    '<div class="metric-row"><span>Archetype</span><span>'+(c.archetype||'N/A')+'</span></div>'+
    '<div class="metric-row"><span>Sector Position</span><span>'+pos+' ('+peers+' peers, avg '+avgPeer+')</span></div>'+
    '<div class="esg-bars">'+
    '<div class="esg-bar bar-e"><label>Environmental: '+e+'</label><div class="bar"><div class="bar-fill" style="width:'+e+'%"></div></div></div>'+
    '<div class="esg-bar bar-s"><label>Social: '+s+'</label><div class="bar"><div class="bar-fill" style="width:'+s+'%"></div></div></div>'+
    '<div class="esg-bar bar-g"><label>Governance: '+g+'</label><div class="bar"><div class="bar-fill" style="width:'+g+'%"></div></div></div>'+
    '</div>';
  
  const em=a.emissions||{};
  const emHtml=(em.total?'<div class="metric-row"><span>Total Emissions</span><span>'+Number(em.total).toLocaleString()+' mtCO2e</span></div>':'')+
    (em.scope1?'<div class="metric-row"><span>Scope 1</span><span>'+Number(em.scope1).toLocaleString()+'</span></div>':'')+
    (em.scope2?'<div class="metric-row"><span>Scope 2</span><span>'+Number(em.scope2).toLocaleString()+'</span></div>':'')+
    (em.scope3?'<div class="metric-row"><span>Scope 3</span><span>'+Number(em.scope3).toLocaleString()+'</span></div>':'');
  
  const card=html+(emHtml?emHtml:'')+'</div>';
  addMsg('bot',card,true);
}

let msgId=0;
function addMsg(type,content,isHtml){
  const id='msg-'+(++msgId);
  const d=document.createElement('div');
  d.className='msg '+type;
  d.id=id;
  if(isHtml)d.innerHTML=content;
  else d.innerHTML=content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
  document.getElementById('msgs').appendChild(d);
  d.scrollIntoView({behavior:'smooth'});
  return id;
}
function updateMsg(id,content){const el=document.getElementById(id);if(el)el.innerHTML=content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');}
function removeMsg(id){const el=document.getElementById(id);if(el)el.remove();}

// Chat input handling
async function handleSend(){
  const inp=document.getElementById('inp');
  const q=inp.value.trim();
  if(!q)return;
  inp.value='';
  addMsg('user',q);
  
  const lower=q.toLowerCase();
  
  // Portfolio overview
  if(lower.match(/portfolio|overview|summary|all companies/)){
    const secs={};
    companies.forEach(c=>{const s=c.sector||'Unknown';if(!secs[s])secs[s]=[];secs[s].push(c);});
    const avg=Math.round(companies.reduce((a,c)=>a+(c.esg_score||0),0)/companies.length);
    let txt='**Portfolio Overview ‚Äî '+companies.length+' Companies**\n\nAverage ESG: **'+avg+'/100**\n\n';
    Object.keys(secs).sort().forEach(s=>{
      const arr=secs[s];
      const savg=Math.round(arr.reduce((a,c)=>a+(c.esg_score||0),0)/arr.length);
      txt+=s+': '+arr.length+' companies (avg ESG: '+savg+')\n';
    });
    addMsg('bot',txt);
    return;
  }
  
  // High risk
  if(lower.match(/high risk|critical|worst|laggard/)){
    const loadId=addMsg('bot','<div class="loading"></div> Fetching high-risk companies...');
    try{
      const r=await fetch(API+'/api/suppliers/filter/high-risk');
      const d=await r.json();
      removeMsg(loadId);
      if(d.companies&&d.companies.length){
        let txt='**High Risk Companies ('+d.count+')**\n\n';
        d.companies.forEach(c=>txt+=c.name+' ‚Äî ESG: '+(c.esg_score||'N/A')+' | '+c.sector+' | Risk: '+(c.risk_level||'').toUpperCase()+'\n');
        addMsg('bot',txt);
      }else addMsg('bot','No high-risk companies found.');
    }catch(e){addMsg('bot','‚ùå Error: '+e.message);}
    return;
  }
  
  // Top performers
  if(lower.match(/top|best|leader|performer/)){
    const loadId=addMsg('bot','<div class="loading"></div> Fetching top performers...');
    try{
      const r=await fetch(API+'/api/suppliers/filter/top-performers?limit=10');
      const d=await r.json();
      removeMsg(loadId);
      let txt='**Top 10 ESG Performers**\n\n';
      d.companies.forEach((c,i)=>txt+=(i+1)+'. '+c.name+' ‚Äî **'+c.esg_score+'/100** | '+c.sector+' | E:'+c.environmental_score+' S:'+c.social_score+' G:'+c.governance_score+'\n');
      addMsg('bot',txt);
    }catch(e){addMsg('bot','‚ùå Error: '+e.message);}
    return;
  }
  
  // Sector query
  const sectorMatch=lower.match(/mining|financial|retail|property|technology|construction|energy|health|telecom|industrial|logistics|banking|insurance|investment|media|chemical|food|paper|diversified|agriculture|automotive|education|hospitality/);
  if(sectorMatch){
    const loadId=addMsg('bot','<div class="loading"></div> Analyzing sector...');
    const sectorCompanies=companies.filter(c=>c.sector&&c.sector.toLowerCase().includes(sectorMatch[0]));
    removeMsg(loadId);
    if(sectorCompanies.length){
      const avg=Math.round(sectorCompanies.reduce((a,c)=>a+(c.esg_score||0),0)/sectorCompanies.length);
      let txt='**'+sectorCompanies[0].sector+' Sector Analysis ('+sectorCompanies.length+' companies)**\n\nAverage ESG: **'+avg+'/100**\n\n';
      sectorCompanies.sort((a,b)=>(b.esg_score||0)-(a.esg_score||0)).forEach(c=>{
        txt+=c.name+' ‚Äî ESG: '+(c.esg_score||'N/A')+' | E:'+(c.environmental_score||'-')+' S:'+(c.social_score||'-')+' G:'+(c.governance_score||'-')+' | Risk: '+(c.risk_level||'').toUpperCase()+'\n';
      });
      addMsg('bot',txt);
    }else addMsg('bot','No companies found in that sector.');
    return;
  }
  
  // Company name search
  const nameMatch=companies.find(c=>lower.includes(c.name.toLowerCase().substring(0,10)));
  if(nameMatch){
    selectCompany(nameMatch.id);
    return;
  }
  
  // Default response
  addMsg('bot','I can help with:\n\n- **Select a company** from the panel for detailed ESG analysis\n- **"portfolio overview"** ‚Äî full portfolio summary\n- **"top performers"** ‚Äî best ESG scores\n- **"high risk"** ‚Äî companies needing attention\n- **"mining sector"** (or any sector) ‚Äî sector breakdown\n- **Type a company name** ‚Äî e.g. "Standard Bank" for analysis\n\nTry one of these commands, or click any company on the left.');
}

document.getElementById('sbtn').addEventListener('click',handleSend);
document.getElementById('inp').addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSend();}});
document.getElementById('search').addEventListener('input',renderList);

loadCompanies();
</script>
</body>
</html>
